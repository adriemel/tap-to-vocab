<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jungle Run ‚Äì Tap-to-Vocab</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    .game-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .game-hud {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 400px;
      align-items: center;
    }
    .game-score {
      font-size: 2rem;
      font-weight: 900;
      color: var(--warn);
      letter-spacing: -1px;
    }
    .canvas-container {
      position: relative;
      display: inline-block;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(108,168,255,0.15);
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    canvas {
      display: block;
      border-radius: 16px;
      max-width: 100%;
      touch-action: none;
    }
    .game-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(6,10,22,0.9);
      border-radius: 16px;
      gap: 16px;
      z-index: 10;
    }
    .game-overlay h2 {
      color: var(--ink);
      font-size: 2rem;
      margin: 0;
    }
    .game-overlay .final-score {
      font-size: 5rem;
      font-weight: 900;
      color: var(--warn);
      line-height: 1;
    }
    .game-overlay .score-label {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: -8px;
    }
    .mute-btn {
      background: none;
      border: 1px solid var(--muted);
      color: var(--muted);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üêí Jungle Run</h1>
      <div class="game-wrapper">
        <div class="game-hud">
          <span class="game-score" id="score-display">0</span>
          <button id="btn-mute" class="mute-btn" title="Mute">üîä</button>
        </div>

        <div class="canvas-container" id="canvas-container">
          <canvas id="game-canvas" width="400" height="300"></canvas>

          <div class="game-overlay" id="overlay-start">
            <h2>üêí Jungle Run</h2>
            <p style="color:var(--muted);text-align:center;margin:0;max-width:260px;line-height:1.7;">
              Tap or press Space to jump over gaps and collect bananas!
            </p>
            <button class="btn" id="btn-start" style="min-width:140px;font-size:1.1rem;">‚ñ∂ Start</button>
          </div>

          <div class="game-overlay" id="overlay-end" style="display:none;">
            <h2>Game Over</h2>
            <div class="final-score" id="final-score">0</div>
            <div class="score-label">bananas collected</div>
            <div class="score-label" id="best-score" style="color:var(--accent);margin-top:2px;"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:4px;">
              <button class="btn" id="btn-again" style="min-width:130px;">‚ñ∂ Play Again</button>
              <button class="btn secondary" onclick="location.replace('/games.html')" style="min-width:130px;text-align:center;">‚úì Done</button>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="btn secondary" onclick="location.replace('/games.html')">‚Üê Back</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function () {
    var canvas = document.getElementById("game-canvas");
    var ctx = canvas.getContext("2d");
    var W = canvas.width;
    var H = canvas.height;

    var scoreDisplay = document.getElementById("score-display");
    var overlayStart = document.getElementById("overlay-start");
    var overlayEnd   = document.getElementById("overlay-end");
    var finalScoreEl = document.getElementById("final-score");
    var bestScoreEl  = document.getElementById("best-score");
    var btnStart     = document.getElementById("btn-start");
    var btnAgain     = document.getElementById("btn-again");

    /* ‚îÄ‚îÄ Constants ‚îÄ‚îÄ */
    var GROUND_Y    = H - 50;
    var MONKEY_REST = GROUND_Y - 18; // monkey feet touch ground
    var MONKEY_X    = 80;
    var GRAVITY     = 0.65;
    var JUMP_VEL    = -11;
    var BASE_SPEED  = 3.5;

    /* ‚îÄ‚îÄ Colors ‚îÄ‚îÄ */
    var SKY_TOP     = "#0b1a2e";
    var SKY_BOT     = "#1a3a2a";
    var GROUND_C    = "#3a2a1a";
    var GROUND_TOP  = "#4a6a3a";
    var BANANA_C    = "#ffe135";

    /* ‚îÄ‚îÄ Game state ‚îÄ‚îÄ */
    var monkeyY = 0, velY = 0, onGround = true;
    var score = 0, bestScore = 0, gameRunning = false, animFrame = null;
    var speed = BASE_SPEED, frameCount = 0;
    var segments = [], bananas = [], particles = [];
    var runPhase = 0;
    var fallAnim = null; // { y, vy, rot, alpha }

    /* ‚îÄ‚îÄ Parallax layers ‚îÄ‚îÄ */
    var bgTrees = [], fgBushes = [];
    (function genBG() {
      for (var i = 0; i < 12; i++) {
        bgTrees.push({ x: Math.random() * W * 1.5, h: 40 + Math.random() * 60, w: 20 + Math.random() * 15 });
      }
      for (var j = 0; j < 8; j++) {
        fgBushes.push({ x: Math.random() * W * 1.5, w: 25 + Math.random() * 20, h: 15 + Math.random() * 10 });
      }
    })();

    /* ‚îÄ‚îÄ Audio ‚îÄ‚îÄ */
    var audioCtx = null;
    var isMuted = localStorage.getItem("tapvocab_mute") === "1";
    var musicGain = null;
    var musicInterval = null;
    var musicPlaying = false;

    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();
      return audioCtx;
    }

    function unlockAudio() {
      var ac = getAudioCtx();
      if (ac.state === "running") return;
      var buf = ac.createBuffer(1, 1, ac.sampleRate);
      var src = ac.createBufferSource();
      src.buffer = buf;
      src.connect(ac.destination);
      src.start(0);
      ac.resume();
    }

    function playJumpSound() {
      if (isMuted) return;
      var ac = getAudioCtx();
      var osc = ac.createOscillator();
      var gain = ac.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(300, ac.currentTime);
      osc.frequency.linearRampToValueAtTime(600, ac.currentTime + 0.1);
      gain.gain.setValueAtTime(0.12, ac.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.12);
      osc.connect(gain); gain.connect(ac.destination);
      osc.start(ac.currentTime); osc.stop(ac.currentTime + 0.12);
    }

    function playBananaSound() {
      if (isMuted) return;
      var ac = getAudioCtx();
      var osc = ac.createOscillator();
      var gain = ac.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(900, ac.currentTime);
      osc.frequency.linearRampToValueAtTime(1100, ac.currentTime + 0.08);
      gain.gain.setValueAtTime(0.13, ac.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.12);
      osc.connect(gain); gain.connect(ac.destination);
      osc.start(ac.currentTime); osc.stop(ac.currentTime + 0.12);
    }

    function playFallSound() {
      if (isMuted) return;
      var ac = getAudioCtx();
      var osc = ac.createOscillator();
      var gain = ac.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(400, ac.currentTime);
      osc.frequency.exponentialRampToValueAtTime(80, ac.currentTime + 0.35);
      gain.gain.setValueAtTime(0.18, ac.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.35);
      osc.connect(gain); gain.connect(ac.destination);
      osc.start(ac.currentTime); osc.stop(ac.currentTime + 0.4);
    }

    /* ‚îÄ‚îÄ Music (chiptune jungle ‚Äì D major, 140 BPM) ‚îÄ‚îÄ */
    var MUSIC_BPM = 140;
    var BEAT_SEC = 60 / MUSIC_BPM;
    var jrMelody = [587,659,740,587,880,740,659,587, 740,880,988,880,740,659,587,659];
    var jrBass   = [147,147,175,175,220,220,175,175, 147,147,220,220,175,175,147,147];
    var musicStep = 0;
    var SCHEDULE_AHEAD = 0.15;
    var musicNextTime = 0;

    function startMusic() {
      if (isMuted) return;
      var ac = getAudioCtx();
      musicGain = ac.createGain();
      musicGain.gain.setValueAtTime(0.10, ac.currentTime);
      musicGain.connect(ac.destination);
      musicPlaying = true;
      musicStep = 0;
      musicNextTime = ac.currentTime;
      scheduleMusic();
    }

    function scheduleMusic() {
      if (!musicPlaying || !musicGain) return;
      var ac = getAudioCtx();
      while (musicNextTime < ac.currentTime + SCHEDULE_AHEAD) {
        var dur = BEAT_SEC * 0.7;
        var o1 = ac.createOscillator();
        var g1 = ac.createGain();
        o1.type = "square";
        o1.frequency.value = jrMelody[musicStep % jrMelody.length];
        g1.gain.setValueAtTime(0.07, musicNextTime);
        g1.gain.exponentialRampToValueAtTime(0.001, musicNextTime + dur);
        o1.connect(g1); g1.connect(musicGain);
        o1.start(musicNextTime); o1.stop(musicNextTime + dur);
        var o2 = ac.createOscillator();
        var g2 = ac.createGain();
        o2.type = "triangle";
        o2.frequency.value = jrBass[musicStep % jrBass.length];
        g2.gain.setValueAtTime(0.10, musicNextTime);
        g2.gain.exponentialRampToValueAtTime(0.001, musicNextTime + BEAT_SEC * 0.9);
        o2.connect(g2); g2.connect(musicGain);
        o2.start(musicNextTime); o2.stop(musicNextTime + BEAT_SEC);
        musicStep++;
        musicNextTime += BEAT_SEC;
      }
      if (musicPlaying) musicInterval = setTimeout(scheduleMusic, 100);
    }

    function stopMusic() {
      musicPlaying = false;
      if (musicInterval) { clearTimeout(musicInterval); musicInterval = null; }
      if (musicGain && audioCtx) {
        try {
          musicGain.gain.cancelScheduledValues(audioCtx.currentTime);
          musicGain.gain.setValueAtTime(musicGain.gain.value, audioCtx.currentTime);
          musicGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
        } catch(e) {}
        setTimeout(function() { musicGain = null; }, 400);
      }
    }

    /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
    function rand(lo, hi) { return Math.random() * (hi - lo) + lo; }

    /* ‚îÄ‚îÄ Ground segments ‚îÄ‚îÄ */
    // Each segment: { x, w } ‚Äî a solid ground piece. Gaps are the spaces between segments.
    function generateInitialSegments() {
      segments = [];
      // Start with solid ground under monkey
      segments.push({ x: -100, w: 350 });
      var nextX = 250;
      for (var i = 0; i < 20; i++) {
        var gapW = 40 + Math.random() * 30;
        var segW = 100 + Math.random() * 150;
        segments.push({ x: nextX + gapW, w: segW });
        nextX = nextX + gapW + segW;
      }
    }

    function spawnBananasOnSegment(seg) {
      // Place 0-3 bananas on a segment
      var count = Math.floor(Math.random() * 3);
      for (var i = 0; i < count; i++) {
        var bx = seg.x + 20 + Math.random() * (seg.w - 40);
        var by = GROUND_Y - 30 - Math.random() * 40;
        bananas.push({ x: bx, y: by, phase: Math.random() * Math.PI * 2, collected: false });
      }
    }

    /* ‚îÄ‚îÄ Draw background ‚îÄ‚îÄ */
    function drawBG() {
      var g = ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, SKY_TOP);
      g.addColorStop(0.7, SKY_BOT);
      g.addColorStop(1, GROUND_C);
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);

      // Background trees (parallax slow)
      ctx.fillStyle = "#1a3a20";
      for (var i = 0; i < bgTrees.length; i++) {
        var t = bgTrees[i];
        var tx = ((t.x - frameCount * speed * 0.2) % (W * 1.5) + W * 1.5) % (W * 1.5) - W * 0.25;
        // Trunk
        ctx.fillStyle = "#3a2a18";
        ctx.fillRect(tx + t.w / 2 - 3, GROUND_Y - t.h, 6, t.h);
        // Canopy
        ctx.fillStyle = "#1a4a24";
        ctx.beginPath();
        ctx.arc(tx + t.w / 2, GROUND_Y - t.h - 5, t.w / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#2a5a30";
        ctx.beginPath();
        ctx.arc(tx + t.w / 2 - 5, GROUND_Y - t.h, t.w / 2 - 4, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    /* ‚îÄ‚îÄ Draw ground segments ‚îÄ‚îÄ */
    function drawGround() {
      for (var i = 0; i < segments.length; i++) {
        var s = segments[i];
        // Grass top
        ctx.fillStyle = GROUND_TOP;
        ctx.fillRect(s.x, GROUND_Y, s.w, 6);
        // Dirt body
        ctx.fillStyle = GROUND_C;
        ctx.fillRect(s.x, GROUND_Y + 6, s.w, H - GROUND_Y - 6);
        // Darker dirt line
        ctx.fillStyle = "#2a1a0a";
        ctx.fillRect(s.x, GROUND_Y + 14, s.w, 2);
        // Left edge
        ctx.fillStyle = "#2a1a0a";
        ctx.fillRect(s.x, GROUND_Y, 2, H - GROUND_Y);
        // Right edge
        ctx.fillRect(s.x + s.w - 2, GROUND_Y, 2, H - GROUND_Y);
      }
    }

    /* ‚îÄ‚îÄ Draw monkey ‚îÄ‚îÄ */
    function drawMonkey(mx, my, rot) {
      ctx.save();
      ctx.translate(mx, my);
      if (rot) ctx.rotate(rot);

      var bob = onGround ? Math.sin(runPhase) * 2 : 0;
      var legPhase = onGround ? Math.sin(runPhase * 2) : 0.5;

      // Tail
      ctx.strokeStyle = "#8B5E3C";
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(-10, -5 + bob);
      ctx.quadraticCurveTo(-20, -18 + bob, -16, -25 + bob + Math.sin(runPhase) * 3);
      ctx.stroke();

      // Legs
      var legW = 5, legH = 10;
      ctx.fillStyle = "#8B5E3C";
      // Left leg
      ctx.fillRect(-7, 8 + bob + legPhase * 3, legW, legH);
      // Right leg
      ctx.fillRect(2, 8 + bob - legPhase * 3, legW, legH);

      // Feet
      ctx.fillStyle = "#6B4423";
      ctx.fillRect(-8, 16 + bob + legPhase * 3, legW + 2, 4);
      ctx.fillRect(1, 16 + bob - legPhase * 3, legW + 2, 4);

      // Body
      ctx.fillStyle = "#A0724A";
      ctx.beginPath();
      ctx.ellipse(0, 0 + bob, 12, 14, 0, 0, Math.PI * 2);
      ctx.fill();

      // Belly
      ctx.fillStyle = "#D4A76A";
      ctx.beginPath();
      ctx.ellipse(1, 3 + bob, 7, 8, 0, 0, Math.PI * 2);
      ctx.fill();

      // Arms
      ctx.fillStyle = "#8B5E3C";
      ctx.save();
      ctx.translate(-12, -4 + bob);
      ctx.rotate(-0.3 + legPhase * 0.15);
      ctx.fillRect(-3, 0, 5, 12);
      ctx.restore();
      ctx.save();
      ctx.translate(12, -4 + bob);
      ctx.rotate(0.3 - legPhase * 0.15);
      ctx.fillRect(-2, 0, 5, 12);
      ctx.restore();

      // Head
      var headY = -18 + bob;
      ctx.fillStyle = "#A0724A";
      ctx.beginPath();
      ctx.arc(0, headY, 10, 0, Math.PI * 2);
      ctx.fill();

      // Face
      ctx.fillStyle = "#D4A76A";
      ctx.beginPath();
      ctx.ellipse(0, headY + 2, 7, 7, 0, 0, Math.PI * 2);
      ctx.fill();

      // Ears
      ctx.fillStyle = "#D4A76A";
      ctx.beginPath();
      ctx.arc(-10, headY - 2, 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(10, headY - 2, 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#C4976A";
      ctx.beginPath();
      ctx.arc(-10, headY - 2, 2.5, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(10, headY - 2, 2.5, 0, Math.PI * 2);
      ctx.fill();

      // Eyes
      ctx.fillStyle = "#2a1a0a";
      ctx.beginPath();
      ctx.arc(-4, headY - 1, 2, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(4, headY - 1, 2, 0, Math.PI * 2);
      ctx.fill();
      // Eye shine
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(-3.3, headY - 2, 0.8, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(4.7, headY - 2, 0.8, 0, Math.PI * 2);
      ctx.fill();

      // Mouth / smile
      ctx.strokeStyle = "#6B4423";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.arc(0, headY + 2, 3.5, 0.2, Math.PI - 0.2);
      ctx.stroke();

      ctx.restore();
    }

    /* ‚îÄ‚îÄ Draw banana ‚îÄ‚îÄ */
    function drawBanana(b) {
      var by = b.y + Math.sin(frameCount * 0.06 + b.phase) * 4;

      // Glow
      ctx.shadowColor = BANANA_C;
      ctx.shadowBlur = 10;

      // Banana shape (crescent)
      ctx.fillStyle = BANANA_C;
      ctx.beginPath();
      ctx.arc(b.x, by, 10, 0.3, Math.PI - 0.3);
      ctx.arc(b.x, by - 4, 12, Math.PI - 0.5, 0.5, true);
      ctx.closePath();
      ctx.fill();

      // Darker edge
      ctx.strokeStyle = "#c4a020";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(b.x, by, 10, 0.3, Math.PI - 0.3);
      ctx.stroke();

      // Stem
      ctx.fillStyle = "#8B7320";
      ctx.fillRect(b.x + 6, by - 9, 3, 5);

      ctx.shadowBlur = 0;
    }

    /* ‚îÄ‚îÄ Particles ‚îÄ‚îÄ */
    function spawnParticles(px, py, color) {
      for (var i = 0; i < 6; i++) {
        var angle = (Math.PI * 2 / 6) * i + rand(-0.3, 0.3);
        particles.push({
          x: px, y: py,
          vx: Math.cos(angle) * rand(1.5, 3),
          vy: Math.sin(angle) * rand(1.5, 3),
          life: 1,
          size: rand(2, 5),
          color: color
        });
      }
    }

    function updateParticles() {
      for (var i = particles.length - 1; i >= 0; i--) {
        var p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.04;
        if (p.life <= 0) particles.splice(i, 1);
      }
    }

    function drawParticles() {
      for (var i = 0; i < particles.length; i++) {
        var p = particles[i];
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    /* ‚îÄ‚îÄ Check if monkey is over ground ‚îÄ‚îÄ */
    function isOverGround(mx) {
      for (var i = 0; i < segments.length; i++) {
        var s = segments[i];
        if (mx >= s.x + 6 && mx <= s.x + s.w - 6) return true;
      }
      return false;
    }

    /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
    function initGame() {
      monkeyY = MONKEY_REST;
      velY = 0;
      onGround = true;
      score = 0;
      speed = BASE_SPEED;
      frameCount = 0;
      runPhase = 0;
      particles = [];
      bananas = [];
      fallAnim = null;
      generateInitialSegments();
      // Spawn initial bananas
      for (var i = 1; i < segments.length; i++) {
        spawnBananasOnSegment(segments[i]);
      }
      scoreDisplay.textContent = "0";
      gameRunning = true;
      startMusic();
      loop();
    }

    function gameOver() {
      gameRunning = false;
      stopMusic();
      playFallSound();

      // Fall animation
      fallAnim = { y: monkeyY, vy: -3, rot: 0, alpha: 1 };
      var deathFrames = 0;

      function deathLoop() {
        deathFrames++;
        fallAnim.vy += 0.5;
        fallAnim.y += fallAnim.vy;
        fallAnim.rot += 0.1;
        fallAnim.alpha = Math.max(0, 1 - deathFrames / 60);

        updateParticles();
        drawBG();
        drawGround();
        for (var i = 0; i < bananas.length; i++) {
          if (!bananas[i].collected) drawBanana(bananas[i]);
        }
        drawParticles();

        // Draw falling monkey
        ctx.globalAlpha = fallAnim.alpha;
        drawMonkey(MONKEY_X, fallAnim.y, fallAnim.rot);
        ctx.globalAlpha = 1;

        if (deathFrames < 60) {
          requestAnimationFrame(deathLoop);
        } else {
          if (score > bestScore) bestScore = score;
          finalScoreEl.textContent = score;
          if (bestScore > 0) {
            bestScoreEl.textContent = score >= bestScore && score > 0 ? "‚≠ê New Best: " + bestScore : "Best: " + bestScore;
          } else {
            bestScoreEl.textContent = "";
          }
          overlayEnd.style.display = "flex";

          // Decrement game lives
          var lives = parseInt(sessionStorage.getItem("game_lives") || "0", 10);
          if (lives > 0) {
            lives--;
            sessionStorage.setItem("game_lives", String(lives));
          }
          if (lives <= 0) {
            btnAgain.style.display = "none";
          } else {
            btnAgain.style.display = "";
          }
        }
      }
      deathLoop();
    }

    /* ‚îÄ‚îÄ Main loop ‚îÄ‚îÄ */
    function loop() {
      if (!gameRunning) return;
      if (musicPlaying) scheduleMusic();
      frameCount++;
      runPhase += 0.2;

      // Difficulty ramp
      if (frameCount % 400 === 0) {
        speed += 0.2;
      }

      // Scroll everything left
      for (var i = 0; i < segments.length; i++) {
        segments[i].x -= speed;
      }
      for (var i = 0; i < bananas.length; i++) {
        bananas[i].x -= speed;
      }

      // Remove off-screen segments and spawn new ones
      if (segments.length > 0 && segments[0].x + segments[0].w < -50) {
        segments.shift();
      }
      // Ensure enough segments ahead
      var last = segments[segments.length - 1];
      while (last.x + last.w < W + 500) {
        var gapW = 45 + Math.random() * (25 + Math.min(frameCount * 0.01, 30));
        var segW = 80 + Math.random() * 140;
        var newSeg = { x: last.x + last.w + gapW, w: segW };
        segments.push(newSeg);
        spawnBananasOnSegment(newSeg);
        last = newSeg;
      }

      // Remove off-screen bananas
      for (var i = bananas.length - 1; i >= 0; i--) {
        if (bananas[i].x < -30) bananas.splice(i, 1);
      }

      // Jump physics
      if (!onGround) {
        velY += GRAVITY;
        monkeyY += velY;
        if (monkeyY >= MONKEY_REST && isOverGround(MONKEY_X)) {
          monkeyY = MONKEY_REST;
          velY = 0;
          onGround = true;
        }
      } else {
        // Check if still on ground
        if (!isOverGround(MONKEY_X)) {
          onGround = false;
          // Monkey walks off edge ‚Äî starts falling
        }
      }

      // Fell into crevice
      if (monkeyY > H + 30) {
        gameOver();
        return;
      }

      // Banana collection
      for (var i = bananas.length - 1; i >= 0; i--) {
        var b = bananas[i];
        if (b.collected) continue;
        var dx = MONKEY_X - b.x;
        var dy = monkeyY - 10 - b.y;
        if (Math.abs(dx) < 20 && Math.abs(dy) < 25) {
          b.collected = true;
          score++;
          scoreDisplay.textContent = score;
          spawnParticles(b.x, b.y, BANANA_C);
          playBananaSound();
          bananas.splice(i, 1);
        }
      }

      updateParticles();

      // Draw
      drawBG();
      drawGround();
      for (var i = 0; i < bananas.length; i++) {
        if (!bananas[i].collected) drawBanana(bananas[i]);
      }
      drawParticles();
      drawMonkey(MONKEY_X, monkeyY, 0);

      animFrame = requestAnimationFrame(loop);
    }

    /* ‚îÄ‚îÄ Jump action ‚îÄ‚îÄ */
    function jump() {
      if (!gameRunning) return;
      if (onGround) {
        velY = JUMP_VEL;
        onGround = false;
        playJumpSound();
      }
    }

    /* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
    canvas.addEventListener("pointerdown", function (e) {
      e.preventDefault();
      jump();
    });

    document.addEventListener("keydown", function (e) {
      if (e.code === "Space" || e.key === " " || e.key === "ArrowUp") {
        e.preventDefault();
        jump();
      }
    });

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    btnStart.onclick = function () {
      unlockAudio();
      overlayStart.style.display = "none";
      overlayEnd.style.display = "none";
      initGame();
    };

    btnAgain.onclick = function () {
      unlockAudio();
      overlayEnd.style.display = "none";
      initGame();
    };

    /* ‚îÄ‚îÄ Mute button ‚îÄ‚îÄ */
    var btnMute = document.getElementById("btn-mute");
    btnMute.textContent = isMuted ? "\uD83D\uDD07" : "\uD83D\uDD0A";
    btnMute.onclick = function () {
      isMuted = !isMuted;
      localStorage.setItem("tapvocab_mute", isMuted ? "1" : "0");
      btnMute.textContent = isMuted ? "\uD83D\uDD07" : "\uD83D\uDD0A";
      if (isMuted) stopMusic();
      else if (gameRunning) startMusic();
    };

    /* ‚îÄ‚îÄ Responsive sizing ‚îÄ‚îÄ */
    function resizeCanvas() {
      var maxW = Math.min(400, document.getElementById("canvas-container").parentElement.clientWidth - 4);
      canvas.style.width = maxW + "px";
      canvas.style.height = (maxW * (300 / 400)) + "px";
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    /* Initial idle draw */
    drawBG();
    ctx.fillStyle = GROUND_TOP;
    ctx.fillRect(0, GROUND_Y, W, 6);
    ctx.fillStyle = GROUND_C;
    ctx.fillRect(0, GROUND_Y + 6, W, H - GROUND_Y - 6);
  })();
  </script>
</body>
</html>
