<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tapâ€‘toâ€‘Vocab (DE â†” ES) â€“ Better Voices</title>
  <style>
    body { font: 18px/1.4 system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.6rem; margin: 0 0 0.5rem; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; }
    .big { font-size: 2rem; letter-spacing: 1px; margin: 0.8rem 0; }
    input { font-size: 1.2rem; padding: 0.6rem; width: 100%; box-sizing: border-box; }
    button { font-size: 1rem; padding: 0.6rem 1rem; margin-right: .5rem; cursor: pointer; }
    .hint { color:#555; }
    .small { color:#666; font-size: .9rem; }
    select { font-size: 1rem; padding: .4rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">Tapâ€‘toâ€‘Vocab (Deutsch â†” EspaÃ±ol)</h1>
    <div id="prompt" class="big"></div>
    <div id="translation" class="hint"></div>
    <p>
      <button id="speak">ðŸ”Š AnhÃ¶ren</button>
      <button id="reveal">ðŸ‘€ Anzeigen/Verbergen</button>
    </p>
    <p class="small">
      Stimme: 
      <select id="voiceSelect"></select>
      <button id="testVoice" type="button">Stimme testen</button>
      <span id="voiceInfo" class="small"></span>
    </p>
    <p><strong>Schreibweise Ã¼ben:</strong></p>
    <form id="spell-form">
      <input id="spell" autocomplete="off" placeholder="Schreibe das Wortâ€¦" />
      <p id="feedback"></p>
      <button type="submit">PrÃ¼fen</button>
      <button type="button" id="showLetter">Tipp: nÃ¤chsten Buchstaben</button>
    </form>
    <p id="sentence"></p>
  </div>

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  // Params:
  // w  = Spanish word
  // de = German word/translation
  // lang = preferred Spanish locale (es-ES, es-MX, es-AR). Used as a *hint*.
  // sent = example sentence
  // mode = prompt-de | prompt-es | listen-spell-es | listen-spell-de
  // voice = optional substring to match a specific voice name (e.g., "Google espaÃ±ol" or "Microsoft Sabina")
  const w = (qs.get("w") || "").trim();
  const de = (qs.get("de") || "").trim();
  const langPref = (qs.get("lang") || "es-ES").trim();
  const sent = (qs.get("sent") || "").trim();
  const mode = (qs.get("mode") || "prompt-de").trim();
  const voiceHint = (qs.get("voice") || "").trim().toLowerCase();

  const promptEl = document.getElementById("prompt");
  const translationEl = document.getElementById("translation");
  const sentenceEl = document.getElementById("sentence");
  const speakBtn = document.getElementById("speak");
  const revealBtn = document.getElementById("reveal");
  const form = document.getElementById("spell-form");
  const input = document.getElementById("spell");
  const feedback = document.getElementById("feedback");
  const showLetter = document.getElementById("showLetter");

  const voiceSelect = document.getElementById("voiceSelect");
  const testVoice = document.getElementById("testVoice");
  const voiceInfo = document.getElementById("voiceInfo");

  let hidden = true;
  function render() {
    if (mode === "prompt-de" || mode === "listen-spell-es") {
      promptEl.textContent = de || "Hinweis (Deutsch)";
      translationEl.textContent = hidden ? "â€¦" : (w || "");
    } else if (mode === "prompt-es" || mode === "listen-spell-de") {
      promptEl.textContent = w || "Palabra (EspaÃ±ol)";
      translationEl.textContent = hidden ? "â€¦" : (de || "");
    } else {
      promptEl.textContent = de || "Hinweis (Deutsch)";
      translationEl.textContent = hidden ? "â€¦" : (w || "");
    }
    sentenceEl.textContent = sent ? ("ðŸ§© " + sent) : "";
  }
  render();

  // Speech synthesis helpers
  function getVoicesSafe() {
    // Some browsers load voices async
    let list = speechSynthesis.getVoices();
    if (!list || !list.length) return [];
    return list;
  }

  function populateVoiceList() {
    const voices = getVoicesSafe();
    voiceSelect.innerHTML = "";
    // Filter: we want Spanish voices and German voices
    const wantEs = (mode === "prompt-de" || mode === "listen-spell-es");
    const targetLang = wantEs ? "es" : "de";
    const candidates = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith(targetLang));
    // Sort: prefer exact locale match and known natural voices
    const preferredNames = ["Google espaÃ±ol", "Google espaÃ±ol de Estados Unidos", "Microsoft Sabina", "Microsoft Helena", "Paulina", "Conchita", "Lucia", "Mila", "Elena", "Diego", "Francisco", "Klaus", "Hans", "Vicki"];
    candidates.sort((a,b)=>{
      // exact locale priority
      const score = (v)=>{
        let s = 0;
        if ((v.lang||"").toLowerCase().startsWith(targetLang)) s += 1;
        if ((v.lang||"").toLowerCase() === langPref.toLowerCase()) s += 3;
        if (preferredNames.some(n=> (v.name||"").toLowerCase().includes(n.toLowerCase()))) s += 2;
        if (v.localService) s += 0.5; // sometimes more natural
        return -s;
      };
      return score(a) - score(b);
    });
    const finalList = candidates.length ? candidates : voices; // fallback to all voices

    finalList.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.name;
      opt.textContent = v.name + " (" + v.lang + ")";
      voiceSelect.appendChild(opt);
    });

    // Try to preselect: voice hint, else best match by locale
    let pre = null;
    if (voiceHint) pre = finalList.find(v => v.name.toLowerCase().includes(voiceHint)) || null;
    if (!pre) pre = finalList.find(v => (v.lang||"").toLowerCase() === langPref.toLowerCase()) || null;
    if (!pre) pre = finalList[0] || null;
    if (pre) voiceSelect.value = pre.name;
    voiceInfo.textContent = finalList.length ? "" : "Keine Stimmen gefunden â€“ Browser unterstÃ¼tzt evtl. keine TTSâ€‘Stimmen.";
  }

  function currentVoiceFor(textLang) {
    const name = voiceSelect.value;
    const voices = getVoicesSafe();
    let v = voices.find(v => v.name === name);
    if (!v) {
      // fallback by language
      v = voices.find(v => (v.lang||"").toLowerCase().startsWith(textLang)) || null;
    }
    return v;
  }

  function speak(text, textLang) {
    if (!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    const v = currentVoiceFor(textLang);
    if (v) u.voice = v;
    u.lang = v ? v.lang : (textLang === "es" ? langPref : "de-DE");
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // Init voice list (with async fallback)
  populateVoiceList();
  if (typeof speechSynthesis !== "undefined") {
    speechSynthesis.onvoiceschanged = populateVoiceList;
  }

  testVoice.addEventListener("click", () => {
    const wantEs = (mode === "prompt-de" || mode === "listen-spell-es");
    const sample = wantEs ? (w || "hola") : (de || "hallo");
    speak(sample, wantEs ? "es" : "de");
  });

  // Speak button: target language
  speakBtn.addEventListener("click", () => {
    const wantEs = (mode === "prompt-de" || mode === "listen-spell-es");
    if (wantEs && w) speak(w, "es");
    if (!wantEs && de) speak(de, "de");
  });

  revealBtn.addEventListener("click", () => { hidden = !hidden; render(); });

  // Spelling check
  function normalize(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[Ì€-Í¯]/g,""); }
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const target = (mode === "prompt-de" || mode === "listen-spell-es") ? w : de;
    const ok = normalize(input.value) === normalize(target);
    feedback.textContent = ok ? "âœ… Richtig!" : "âŒ Noch nicht. Nochmal versuchen.";
    if (ok) {
      const wantEs = (mode === "prompt-de" || mode === "listen-spell-es");
      if (wantEs && w) speak(w, "es");
      if (!wantEs && de) speak(de, "de");
      try { localStorage.setItem("lastOk_"+(target||""), Date.now()); } catch(e){}
    }
  });

  showLetter.addEventListener("click", () => {
    const target = (mode === "prompt-de" || mode === "listen-spell-es") ? w : de;
    const typed = input.value;
    let i = 0;
    while (i < typed.length && normalize(typed[i]) === normalize((target||"")[i])) i++;
    input.value = typed.slice(0, i) + ((target||"")[i] || "") + typed.slice(i);
    input.focus();
  });

  // Auto-speak for listen-spell modes (after voices load)
  function autoSpeakIfNeeded() {
    if (mode === "listen-spell-es" && w) speak(w, "es");
    if (mode === "listen-spell-de" && de) speak(de, "de");
  }
  setTimeout(autoSpeakIfNeeded, 400); // small delay for voices to populate
})();
</script>
</body>
</html>
