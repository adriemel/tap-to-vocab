<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tap-to-Vocab ES‚ÜíDE (tap Spanish + sounds)</title>
<style>
  :root{
    --accent:#2563eb; --accent-ink:#fff; --bg:#f8fafc; --card:#ffffff;
    --ink:#0f172a; --muted:#64748b; --border:rgba(148,163,184,.35); --shadow:rgba(2,6,23,.12);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9aa4b2;
      --accent:#3b82f6; --accent-ink:#081018; --border:rgba(148,163,184,.28); --shadow:rgba(0,0,0,.35);
    }
  }
  html,body{height:100%}
  body {
    margin:0;
    background: radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.12), transparent 60%),
                radial-gradient(800px 500px at 120% 10%, rgba(59,130,246,.10), transparent 55%),
                var(--bg);
    color: var(--ink);
    font: 18px/1.55 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .wrap{max-width:760px;margin:2rem auto;padding:0 1rem;}
  h1 { font-size: clamp(1.4rem, 2vw + 1rem, 1.9rem); margin: 0 0 .9rem; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem; box-shadow: 0 10px 30px var(--shadow); }
  .big { font-size: clamp(2.1rem, 4.2vw + 1rem, 3.1rem); letter-spacing: .4px; margin: .85rem 0; }
  .hint { color: var(--muted); font-size: 1.15rem; }
  button {
    font-size: 1.1rem; padding: .7rem 1rem; border-radius: 12px; border: none;
    background: var(--accent); color: var(--accent-ink);
    box-shadow: 0 6px 16px rgba(37,99,235,.25); transition: transform .04s ease, filter .12s ease; cursor: pointer;
  }
  button:hover { filter: brightness(1.03); } button:active { transform: translateY(1px); }
  .ghost { background: transparent; color: var(--ink); border: 1px solid var(--border); box-shadow:none; }
  #wordSpeaker { cursor:pointer; display:none; font-size:.9em; user-select:none; margin-left:.35rem; }
  #feedback { margin:.4rem 0; }
  .ok { color:#16a34a; } .err { color:#b91c1c; }
  .built { font-size: 1.6rem; min-height: 2.2rem; letter-spacing: .5px; padding:.25rem 0; }
  .keys { display:grid; grid-template-columns: repeat(auto-fit, minmax(56px, 1fr)); gap:.5rem; margin-top:.75rem; }
  .key { background: var(--card); color: var(--ink); border:1px solid var(--border); box-shadow:none; }
  .actions { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
  .pill { border-radius:999px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Espa√±ol ‚Üí Deutsch</h1>
    <div id="prompt" class="big">
      <span id="promptText"></span>
      <span id="wordSpeaker"> üîä</span>
    </div>
    <div id="translation" class="hint"></div>

    <p class="row">
      <button id="speak">üîä Anh√∂ren (Spanisch)</button>
      <button id="reveal" class="ghost">üëÄ Anzeigen / Verbergen</button>
    </p>

    <p><strong>Baue das spanische Wort:</strong></p>
    <div class="built" id="built"></div>
    <div class="keys" id="keys"></div>
    <div class="actions">
      <button class="ghost pill" id="backspace">‚å´ Zur√ºck</button>
      <button class="ghost pill" id="reset">‚Üª Neu</button>
      <button class="ghost pill" id="shuffle">üîÄ Mischen</button>
    </div>

    <p id="feedback"></p>
    <p id="sentence" class="hint"></p>
  </div>
</div>

<script>
(function(){
  const qs   = new URLSearchParams(location.search);
  const w    = (qs.get("w")    || "").trim();        // Spanish (WE BUILD THIS)
  const de   = (qs.get("de")   || "").trim();        // German translation (shown on reveal)
  const sent = (qs.get("sent") || "").trim();
  const lang = (qs.get("lang") || "es-ES").trim();
  const voiceName = (qs.get("voice") || "").trim();

  const $ = id => document.getElementById(id);
  const promptTextEl = $("promptText");
  const wordSpeaker  = $("wordSpeaker");
  const translationEl= $("translation");
  const sentenceEl   = $("sentence");
  const speakBtn     = $("speak");
  const revealBtn    = $("reveal");
  const builtEl      = $("built");
  const keysEl       = $("keys");
  const backspaceBtn = $("backspace");
  const resetBtn     = $("reset");
  const shuffleBtn   = $("shuffle");
  const feedback     = $("feedback");

  let hidden = true;
  let built = "";
  let pool = [];       // {ch, idx, used}
  const target = w;

  // --- tiny sound engine (Web Audio) ---
  let actx;
  function ensureCtx(){ if (!actx && window.AudioContext) actx = new AudioContext(); }
  function beep(freq=880, dur=0.09, type='sine', vol=0.3){
    ensureCtx(); if (!actx) return;
    const o = actx.createOscillator(), g = actx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(actx.destination);
    const t = actx.currentTime;
    g.gain.setValueAtTime(vol, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t + Math.max(0.05, dur));
    o.start(t); o.stop(t + dur);
  }
  function okSound(){ beep(880, 0.08, 'sine', 0.25); }
  function dohSound(){ beep(220, 0.16, 'sawtooth', 0.18); }

  function renderHeader(){
    const hasAny = w || de || sent;
    promptTextEl.textContent = w || (hasAny ? "(Spanisch fehlt)" : "Palabra (Espa√±ol) fehlt");
    translationEl.textContent = hidden ? "‚Ä¶" : (de || (hasAny ? "(Deutsch fehlt)" : "Deutsches Wort fehlt"));
    wordSpeaker.style.display = w ? "inline" : "none";
    sentenceEl.textContent = sent ? ("üß© " + sent) : "";
  }

  function makePool(){
    pool = [];
    for (let i=0;i<target.length;i++){
      pool.push({ ch: target[i], idx: i, used:false });
    }
  }

  function shufflePool(){
    for (let i=pool.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [pool[i],pool[j]] = [pool[j],pool[i]];
    }
  }

  function renderKeys(){
    keysEl.innerHTML = "";
    pool.forEach((cell, k) => {
      if (cell.used) return;   // HIDE used letters completely
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "key";
      btn.textContent = cell.ch === " " ? "‚ê£ Leer" : cell.ch;
      btn.addEventListener("click", () => onTapKey(k, btn));
      keysEl.appendChild(btn);
    });
  }

  function onTapKey(k, btn){
    const cell = pool[k];
    if (!cell || cell.used) return;
    const nextIndex = built.length;
    if (cell.ch === target[nextIndex]){
      built += cell.ch;
      cell.used = true;
      builtEl.textContent = built;
      okSound();
      if (btn && btn.parentNode) btn.parentNode.removeChild(btn); // vanish
      if (built.length === target.length){
        onSolved();
      }
    } else {
      feedback.innerHTML = "<span class='err'>‚ùå Falscher Buchstabe ‚Äì probier den n√§chsten.</span>";
      dohSound();
    }
  }

  function onSolved(){
    feedback.innerHTML = "<span class='ok'>‚úÖ Richtig!</span>";
    speakSpanish(w);
    try { localStorage.setItem("lastOk_"+w, Date.now()); } catch(e){}
  }

  function backspace(){
    if (!built.length) return;
    const lastIndex = built.length - 1;
    const lastChar = built[lastIndex];
    built = built.slice(0, lastIndex);
    const cell = pool.find(c => c.ch === lastChar && c.idx === lastIndex);
    if (cell) cell.used = false;
    builtEl.textContent = built;
    renderKeys();
    feedback.textContent = "";
  }

  function resetAll(){
    built = "";
    makePool(); shufflePool();
    builtEl.textContent = "";
    renderKeys();
    feedback.textContent = "";
  }

  function getVoiceByName(name){
    const voices = speechSynthesis.getVoices() || [];
    return voices.find(v => v.name && v.name.toLowerCase() === name.toLowerCase());
  }
  function speakSpanish(text){
    if (!("speechSynthesis" in window) || !text) return;
    const u = new SpeechSynthesisUtterance(text);
    if (voiceName){
      const v = getVoiceByName(voiceName);
      if (v){ u.voice = v; u.lang = v.lang; } else { u.lang = lang; }
    } else {
      u.lang = lang;
    }
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  speakBtn.addEventListener("click", ()=> speakSpanish(w));
  wordSpeaker.addEventListener("click", ()=> speakSpanish(w));
  revealBtn.addEventListener("click", ()=>{ hidden = !hidden; renderHeader(); });
  backspaceBtn.addEventListener("click", backspace);
  resetBtn.addEventListener("click", resetAll);
  shuffleBtn.addEventListener("click", ()=>{ shufflePool(); renderKeys(); });

  // init
  renderHeader();
  makePool(); shufflePool(); renderKeys();

  if (typeof speechSynthesis !== "undefined") {
    speechSynthesis.onvoiceschanged = function(){ /* no-op */ };
  }
})();
</script>
</body>
</html>
