<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tap-to-Vocab ES‚ÜíDE (Kategorien + iPhone Audio)</title>
<style>
  :root{ --accent:#2563eb; --accent-ink:#fff; --bg:#f8fafc; --card:#ffffff;
         --ink:#0f172a; --muted:#64748b; --border:rgba(148,163,184,.35); --shadow:rgba(2,6,23,.12); }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9aa4b2;
           --accent:#3b82f6; --accent-ink:#081018; --border:rgba(148,163,184,.28); --shadow:rgba(0,0,0,.35); }
  }
  html,body{height:100%}
  body{ margin:0; background:
        radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(800px 500px at 120% 10%, rgba(59,130,246,.10), transparent 55%), var(--bg);
        color:var(--ink); font:18px/1.55 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .wrap{max-width:760px;margin:2rem auto;padding:0 1rem;}
  h1{font-size:clamp(1.4rem, 2vw + 1rem, 1.9rem); margin:0 0 .4rem;}
  .category{color:var(--muted); margin-bottom:.6rem;}
  .card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.25rem;box-shadow:0 10px 30px var(--shadow);overflow:hidden;}
  .big{font-size:clamp(2.1rem,4.2vw + 1rem,3.1rem);letter-spacing:.4px;margin:.5rem 0 .85rem;}
  .hint{color:var(--muted);font-size:1.15rem;}
  button{font-size:1.05rem;padding:.6rem .9rem;border-radius:12px;border:none;background:var(--accent);color:var(--accent-ink);
         box-shadow:0 6px 16px rgba(37,99,235,.25);transition:transform .04s ease, filter .12s ease;cursor:pointer;}
  button:hover{filter:brightness(1.03)} button:active{transform:translateY(1px)}
  .ghost{background:transparent;color:var(--ink);border:1px solid var(--border);box-shadow:none;}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  #wordSpeaker{cursor:pointer;display:none;font-size:.9em;user-select:none;margin-left:.35rem;}
  #feedback{margin:.4rem 0;}
  .ok{color:#16a34a;} .err{color:#b91c1c;}
  .built{font-size:1.6rem;min-height:2.2rem;letter-spacing:.5px;padding:.25rem 0;}
  .keys{display:grid;grid-template-columns:repeat(auto-fit,minmax(56px,1fr));gap:.5rem;margin-top:.75rem;}
  .key{background:var(--card);color:var(--ink);border:1px solid var(--border);box-shadow:none;height:48px;display:flex;align-items:center;justify-content:center;}
  .key.used{visibility:hidden;pointer-events:none;}
  .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem;}
  .pill{border-radius:999px;}
  #confetti{position:absolute;inset:0;pointer-events:none;}
  .counter{margin-left:auto;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <canvas id="confetti"></canvas>

    <h1>Espa√±ol ‚Üí Deutsch</h1>
    <div id="category" class="category" style="display:none"></div>

    <div id="prompt" class="big">
      <span id="promptText"></span>
      <span id="wordSpeaker"> üîä</span>
    </div>
    <div id="translation" class="hint"></div>

    <p class="row">
      <!-- new: back to main page -->
      <button id="backHome" class="ghost">üè† Zur√ºck zur √úbersicht</button>

      <button id="speak">üîä Anh√∂ren (Spanisch)</button>
      <button id="reveal" class="ghost">üëÄ Anzeigen / Verbergen</button>
      <button id="prev" class="ghost">‚¨ÖÔ∏è Vorheriges</button>
      <button id="next" class="ghost">‚û°Ô∏è N√§chstes</button>
      <button id="nextCat" class="ghost">‚è≠Ô∏è N√§chste Kategorie</button>
      <span id="counter" class="counter" style="display:none">‚Äì/‚Äì</span>
    </p>

    <p><strong>Baue das spanische Wort:</strong></p>
    <div class="built" id="built"></div>
    <div class="keys" id="keys"></div>
    <div class="actions">
      <button class="ghost pill" id="backspace">‚å´ Zur√ºck</button>
      <button class="ghost pill" id="reset">‚Üª Neu</button>
    </div>

    <p id="feedback"></p>
    <p id="sentence" class="hint"></p>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  let w    = (qs.get("w")    || "").trim();   // build Spanish
  let de   = (qs.get("de")   || "").trim();   // reveal German
  let sent = (qs.get("sent") || "").trim();
  const catParam = (qs.get("cat") || "").trim();
  const onlyCat  = qs.get("onlyCat")==="1" || qs.get("scope")==="cat";
  const lang  = (qs.get("lang") || "es-ES").trim();
  const voiceName = (qs.get("voice") || "").trim();
  const listFile  = (qs.get("list") || "words.tsv").trim();

  const $ = id => document.getElementById(id);
  const promptTextEl=$("promptText"), wordSpeaker=$("wordSpeaker"), translationEl=$("translation"), sentenceEl=$("sentence");
  const speakBtn=$("speak"), revealBtn=$("reveal"), nextBtn=$("next"), prevBtn=$("prev"), nextCatBtn=$("nextCat");
  const builtEl=$("built"), keysEl=$("keys"), backspaceBtn=$("backspace"), resetBtn=$("reset"), feedback=$("feedback");
  const confettiCanvas=$("confetti"), ctx2d=confettiCanvas.getContext("2d"), counterEl=$("counter"), categoryEl=$("category");
  const backHomeBtn = $("backHome");

  const PROG_KEY = "tsvIndex::" + listFile;

  let hidden=true, built="", pool=[], entries=[], idx=0;
  let categories=[];
  let paramMode = !!(w || de || sent) && !catParam;

  const normalize = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

  function sizeCanvas(){ const r=confettiCanvas.parentElement.getBoundingClientRect(); confettiCanvas.width=r.width|0; confettiCanvas.height=r.height|0; }
  sizeCanvas(); window.addEventListener("resize", sizeCanvas);

  // iPhone-safe audio
  let actx, audioUnlocked=false;
  function getCtx(){ const C=window.AudioContext||window.webkitAudioContext; if(!actx&&C) actx=new C({latencyHint:'interactive'}); return actx; }
  function resumeCtxSync(){ const ctx=getCtx(); if(ctx&&ctx.state==="suspended"){ try{ctx.resume();}catch(e){} } return ctx; }
  function primeTick(){
    const ctx=resumeCtxSync(); if(!ctx) return;
    const len=Math.floor(0.03*ctx.sampleRate), buf=ctx.createBuffer(1,len,ctx.sampleRate), ch=buf.getChannelData(0);
    for(let i=0;i<len;i++){ const t=i/ctx.sampleRate; ch[i]=Math.sin(2*Math.PI*1200*t)*Math.exp(-20*t)*0.4; }
    const src=ctx.createBufferSource(); src.buffer=buf; src.connect(ctx.destination); try{src.start();}catch(e){}
  }
  function unlockAudio(){ if(audioUnlocked) return; audioUnlocked=true; resumeCtxSync(); primeTick(); try{ if(window.speechSynthesis && speechSynthesis.paused) speechSynthesis.resume(); }catch(e){} }
  window.addEventListener("pointerdown", unlockAudio, {once:true});
  window.addEventListener("touchend", unlockAudio, {once:true});
  window.addEventListener("click", unlockAudio, {once:true});

  function makeBeep({freq=880, dur=0.1, type='sine', gain=0.35}={}){
    const ctx=resumeCtxSync(); if(!ctx) return ()=>{};
    const sr=ctx.sampleRate, len=Math.max(1,Math.floor(dur*sr)); const buf=ctx.createBuffer(1,len,sr), ch=buf.getChannelData(0);
    for(let i=0;i<len;i++){ const t=i/sr; let s=0;
      if(type==='sine') s=Math.sin(2*Math.PI*freq*t);
      else if(type==='square') s=Math.sign(Math.sin(2*Math.PI*freq*t));
      else if(type==='sawtooth') s=2*(t*freq - Math.floor(0.5 + t*freq));
      else s=Math.sin(2*Math.PI*freq*t);
      const env=Math.exp(-6*t/dur); ch[i]=s*env*gain;
    }
    return function play(){ const c=resumeCtxSync(); if(!c) return; const src=c.createBufferSource(); src.buffer=buf; src.connect(c.destination); try{src.start();}catch(e){} };
  }
  const okSound  = makeBeep({freq:880, dur:0.1, type:'sine',     gain:0.42});
  const dohSound = makeBeep({freq:220, dur:0.18, type:'sawtooth', gain:0.32});
  function partySound(){
    const ctx=resumeCtxSync(); if(!ctx) return; const notes=[523.25,659.25,783.99]; let when=ctx.currentTime;
    for(const f of notes){ const src=ctx.createBufferSource(); const buf=ctx.createBuffer(1, Math.floor(0.14*ctx.sampleRate), ctx.sampleRate);
      const ch=buf.getChannelData(0); for(let i=0;i<ch.length;i++){ const t=i/ctx.sampleRate, env=Math.exp(-6*t/0.14); ch[i]=Math.sin(2*Math.PI*f*t)*env*0.3; }
      src.buffer=buf; src.connect(ctx.destination); try{src.start(when);}catch(e){}; when+=0.1; }
  }

  // Confetti
  let confetti=[]; function burstConfetti(){ confetti=[]; const N=110;
    for(let i=0;i<N;i++){ confetti.push({x:confettiCanvas.width*.5,y:confettiCanvas.height*.25,vx:(Math.random()*2-1)*3.4,vy:-Math.random()*4.8-2.2,
      g:0.18+Math.random()*0.06,size:3+Math.random()*4,a:1,hue:(190+Math.random()*140)|0,rot:Math.random()*Math.PI*2,vr:(Math.random()*2-1)*0.2,
      shape:Math.random()<0.5?'rect':'tri'}); } animateConfetti(); }
  function drawPiece(p){ ctx2d.save(); ctx2d.translate(p.x,p.y); ctx2d.rotate(p.rot);
    ctx2d.fillStyle=`hsla(${p.hue},98%,58%,${Math.max(0,p.a)})`;
    if(p.shape==='rect'){ ctx2d.fillRect(-p.size,-p.size,p.size*2,p.size*2); }
    else { ctx2d.beginPath(); ctx2d.moveTo(0,-p.size*1.6); ctx2d.lineTo(p.size*1.4,p.size*1.2); ctx2d.lineTo(-p.size*1.4,p.size*1.2); ctx2d.closePath(); ctx2d.fill(); }
    ctx2d.restore(); }
  function animateConfetti(){ let last=performance.now(); (function frame(now){ const dt=Math.min(32,now-last)/16.666; last=now;
    ctx2d.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); let alive=0;
    for(const p of confetti){ p.vy+=p.g*dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.rot+=p.vr*dt; p.a-=0.014*dt;
      if(p.a>0 && p.y<confettiCanvas.height+30){ alive++; drawPiece(p); } } if(alive) requestAnimationFrame(frame); })(last); }

  function updateCounter(){ if(entries.length){ counterEl.style.display="inline"; counterEl.textContent=`${idx+1} / ${entries.length}`; } else { counterEl.style.display="none"; } }
  function updateCategoryHeader(){
    if(!entries.length || idx<0 || idx>=entries.length){ categoryEl.style.display="none"; return; }
    const cat = entries[idx]?.cat || "";
    if(cat){ categoryEl.style.display="block"; categoryEl.textContent = "Kategorie: " + cat; }
    else { categoryEl.style.display="none"; }
  }

  function renderHeader(){
    const hasAny=w||de||sent;
    promptTextEl.textContent = w || (hasAny?"(Spanisch fehlt)":"Palabra (Espa√±ol) fehlt");
    translationEl.textContent = hidden ? "‚Ä¶" : (de || (hasAny?"(Deutsch fehlt)":"Deutsches Wort fehlt"));
    wordSpeaker.style.display = w ? "inline" : "none";
    sentenceEl.textContent = sent ? ("üß© " + sent) : "";
    updateCategoryHeader();
  }
  function makePool(){
    pool=[]; for(let i=0;i<w.length;i++) pool.push({ch:w[i],idx:i,used:false});
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
  }
  function renderKeys(){
    keysEl.innerHTML="";
    pool.forEach((cell,k)=>{
      const btn=document.createElement("button"); btn.type="button"; btn.className="key";
      if(cell.used) btn.classList.add("used");
      btn.textContent=cell.used?"":(cell.ch===" "?"‚ê£ Leer":cell.ch);
      btn.addEventListener("click",()=>onTapKey(k));
      keysEl.appendChild(btn);
    });
  }
  function onTapKey(k){
    unlockAudio();
    const cell=pool[k]; if(!cell||cell.used) return; const next=built.length;
    if(cell.ch===w[next]){ built+=cell.ch; cell.used=true; builtEl.textContent=built; okSound(); renderKeys(); feedback.textContent="";
      if(built.length===w.length){ onSolved(); } }
    else { feedback.innerHTML="<span class='err'>‚ùå Falscher Buchstabe ‚Äì probier den n√§chsten.</span>"; dohSound(); }
  }
  function onSolved(){ feedback.innerHTML="<span class='ok'>‚úÖ Richtig!</span>"; speakSpanish(w); burstConfetti(); partySound();
    try{localStorage.setItem("lastOk_"+w,Date.now());}catch(e){} }
  function backspace(){ unlockAudio(); if(!built.length) return; const lastIdx=built.length-1; const ch=built[lastIdx]; built=built.slice(0,lastIdx);
    const cell=pool.find(c=>c.ch===ch && c.idx===lastIdx); if(cell) cell.used=false; builtEl.textContent=built; renderKeys(); feedback.textContent=""; }
  function resetAll(){ unlockAudio(); built=""; makePool(); builtEl.textContent=""; renderKeys(); feedback.textContent=""; }

  function speakSpanish(text){
    if(!("speechSynthesis" in window)||!text) return; const u=new SpeechSynthesisUtterance(text);
    const vs=speechSynthesis.getVoices()||[]; if(voiceName){ const v=vs.find(v=>v.name&&v.name.toLowerCase()===voiceName.toLowerCase());
      if(v){u.voice=v; u.lang=v.lang;} else {u.lang=lang;} } else { u.lang=lang; }
    try{ speechSynthesis.cancel(); }catch(e){}
    try{ speechSynthesis.speak(u); }catch(e){}
  }

  function findCategoryRange(name){
    const pos = categories.findIndex(c=> (c.name||"") === (name||""));
    if(pos<0) return null;
    const start = categories[pos].start;
    const end   = (pos < categories.length-1) ? categories[pos+1].start - 1 : entries.length - 1;
    return {start, end};
  }

  async function loadList(){
    try{
      const res=await fetch(listFile,{cache:"no-store"}); if(!res.ok) throw new Error(res.status+" "+res.statusText);
      const txt=await res.text();
      let currentCat="";
      entries = [];
      txt.split(/\r?\n/).forEach(line=>{
        const l=line.trim(); if(!l) return;
        if(l.startsWith("##")){ currentCat = l.replace(/^##+/, "").trim(); return; }
        if(l.startsWith("#")) return;
        const p=l.split("\t");
        const e={ w:(p[0]||"").trim(), de:(p[1]||"").trim(), sent:(p[2]||"").trim(), cat: currentCat };
        if(e.w && e.de) entries.push(e);
      });
      categories=[]; let last=null;
      entries.forEach((e,i)=>{ if(e.cat!==last){ categories.push({name:e.cat, start:i}); last=e.cat; } });

      if (catParam){
        const rg = findCategoryRange(catParam);
        if (rg) idx = rg.start;
        paramMode = false;
      } else {
        const saved=parseInt(localStorage.getItem(PROG_KEY)||"0",10);
        idx=isNaN(saved)?0:Math.min(Math.max(saved,0), Math.max(entries.length-1,0));
      }
      if ((w || de) && !catParam){
        const wi = normalize(w), dei = normalize(de);
        const found = entries.findIndex(e => normalize(e.w)===wi && (!de || normalize(e.de)===dei));
        if (found >= 0){ idx = found; }
      }
    }catch(e){ console.warn("TSV load failed:",e); entries=[]; categories=[]; }
    updateCounter(); updateCategoryHeader();
  }

  function setFromEntry(i){
    if(!entries.length) return;
    const e=entries[((i%entries.length)+entries.length)%entries.length];
    w=e.w; de=e.de; sent=e.sent||""; hidden=true; built="";
    renderHeader(); makePool(); renderKeys();
    builtEl.textContent=""; feedback.textContent="";
    updateCounter(); updateCategoryHeader();
  }

  async function nextFromList(){
    if(!entries.length) await loadList();
    if(!entries.length){ feedback.innerHTML="<span class='err'>‚ö†Ô∏è Keine g√ºltige Liste gefunden.</span>"; return; }
    if (onlyCat && entries[idx]){
      const rg = findCategoryRange(entries[idx].cat);
      if (rg){
        idx = (idx < rg.end) ? idx+1 : rg.start;
      } else { idx = (idx < entries.length-1) ? idx+1 : 0; }
    } else {
      idx = (idx < entries.length-1) ? idx+1 : 0;
    }
    localStorage.setItem(PROG_KEY,String(idx));
    paramMode = false;
    setFromEntry(idx);
  }

  async function prevFromList(){
    if(!entries.length) await loadList();
    if(!entries.length){ feedback.innerHTML="<span class='err'>‚ö†Ô∏è Keine g√ºltige Liste gefunden.</span>"; return; }
    if (onlyCat && entries[idx]){
      const rg = findCategoryRange(entries[idx].cat);
      if (rg){
        idx = (idx > rg.start) ? idx-1 : rg.end;
      } else { idx = (idx>0) ? idx-1 : entries.length-1; }
    } else {
      idx = (idx>0) ? idx-1 : entries.length-1;
    }
    localStorage.setItem(PROG_KEY,String(idx));
    paramMode = false;
    setFromEntry(idx);
  }

  async function nextCategory(){
    if(!entries.length) await loadList(); if(!entries.length) return;
    const curCat=entries[idx]?.cat||""; const pos=categories.findIndex(c=>c.name===curCat);
    const next = (pos>=0)?(pos+1)%categories.length:0;
    idx = categories[next].start; localStorage.setItem(PROG_KEY,String(idx));
    paramMode = false;
    setFromEntry(idx);
  }

  // wire
  speakBtn.addEventListener("click", ()=>{ unlockAudio(); speakSpanish(w); });
  wordSpeaker.addEventListener("click", ()=>{ unlockAudio(); speakSpanish(w); });
  revealBtn.addEventListener("click", ()=>{ hidden=!hidden; renderHeader(); });
  backspaceBtn.addEventListener("click", backspace);
  resetBtn.addEventListener("click", resetAll);
  nextBtn.addEventListener("click", nextFromList);
  prevBtn.addEventListener("click", prevFromList);
  nextCatBtn.addEventListener("click", nextCategory);

  // new: back to categories overview
  backHomeBtn.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  (async function init(){
    renderHeader(); makePool(); renderKeys();
    await loadList();
    if (catParam){ setFromEntry(idx); }
    else if ((w || de) && entries.length){ setFromEntry(idx); }
    else if (entries.length){ setFromEntry(idx); }
  })();

  if(typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged=function(){}; }
})();
</script>
</body>
</html>
