<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tap-to-Vocab ESâ†’DE</title>
<style>
  body { font: 18px/1.4 system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
  h1 { font-size: 1.6rem; margin: 0 0 .5rem; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; }
  .big { font-size: 2rem; letter-spacing: 1px; margin: .8rem 0; }
  input { font-size: 1.2rem; padding: .6rem; width: 100%; box-sizing: border-box; }
  button { font-size: 1rem; padding: .6rem 1rem; margin-right: .5rem; cursor: pointer; }
  .hint { color:#555; }
</style>
</head>
<body>
<div class="card">
  <h1>EspaÃ±ol â†’ Deutsch</h1>
  <div id="prompt" class="big"></div>
  <div id="translation" class="hint"></div>
  <p>
    <button id="speak">ðŸ”Š AnhÃ¶ren (DE)</button>
    <button id="reveal">ðŸ‘€ Anzeigen/Verbergen</button>
  </p>
  <p><strong>Schreibweise Ã¼ben (Deutsch):</strong></p>
  <form id="spell-form">
    <input id="spell" autocomplete="off" placeholder="Deutsches Wort schreibenâ€¦" />
    <p id="feedback"></p>
    <button type="submit">PrÃ¼fen</button>
    <button type="button" id="showLetter">Tipp: nÃ¤chsten Buchstaben</button>
  </form>
  <p id="sentence"></p>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const w   = (qs.get("w")    || "").trim();   // Spanish prompt
  const de  = (qs.get("de")   || "").trim();   // German target
  const sent= (qs.get("sent") || "").trim();
  const voiceName = (qs.get("voice") || "").trim(); // exact name (e.g., "Anna (Deutsch)" etc.)

  const $ = id => document.getElementById(id);
  const promptEl = $("prompt"), translationEl=$("translation"),
        sentenceEl=$("sentence"), speakBtn=$("speak"),
        revealBtn=$("reveal"), form=$("spell-form"),
        input=$("spell"), feedback=$("feedback"),
        showLetter=$("showLetter");

  let hidden = true;
  function render(){
    promptEl.textContent = w || "Palabra (EspaÃ±ol)";
    translationEl.textContent = hidden ? "â€¦" : (de || "");
    sentenceEl.textContent = sent ? ("ðŸ§© " + sent) : "";
  }
  render();

  function getVoiceByName(name){
    const voices = speechSynthesis.getVoices() || [];
    return voices.find(v => v.name.toLowerCase() === name.toLowerCase());
  }
  function speak(text){
    if (!("speechSynthesis" in window) || !text) return;
    const u = new SpeechSynthesisUtterance(text);
    if (voiceName){
      const v = getVoiceByName(voiceName);
      if (v){ u.voice = v; u.lang = v.lang; }
      else { u.lang = "de-DE"; }
    } else {
      u.lang = "de-DE";
    }
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  speakBtn.addEventListener("click", ()=> speak(de));
  revealBtn.addEventListener("click", ()=>{ hidden = !hidden; render(); });

  function normalize(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const ok = normalize(input.value) === normalize(de);
    feedback.textContent = ok ? "âœ… Richtig!" : "âŒ Noch nicht. Nochmal versuchen.";
    if (ok){ speak(de); try{ localStorage.setItem("lastOk_"+de, Date.now()); }catch(e){} }
  });

  showLetter.addEventListener("click", ()=>{
    const typed = input.value;
    let i=0; while (i < typed.length && normalize(typed[i]) === normalize(de[i])) i++;
    input.value = typed.slice(0,i) + (de[i]||"") + typed.slice(i);
    input.focus();
  });

  if (typeof speechSynthesis !== "undefined") speechSynthesis.onvoiceschanged = function(){};
})();
</script>
</body>
</html>
